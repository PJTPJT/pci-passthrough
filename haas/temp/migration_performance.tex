% Migration performance.
% - Describe what we have done.
% - Include tables and figures.
% - Evaluate the performance and see if it match our goal.

%\figw{seamless_migration_default}{8}{Place holder for seamless
%migration. Top: Guest sends the outgoing traffic. Bottom:
%guest receives the incoming traffic.}
%\figw{seamless_migration_haas}{8}{Place holder for seamless
%migration. Top: Guest sends the outgoing traffic. Bottom:
%guest receives the incoming traffic.}

\figw{seamless_migration_default}{9}{Live VM migration without \sna.}

\begin{table}[]
\begin{tabular}{|l|l|l|l|}
\hline
 & \begin{tabular}[c]{@{}l@{}}Unplug\\ (ms)\end{tabular} & \begin{tabular}[c]{@{}l@{}}Plug\\ (ms)\end{tabular} & \begin{tabular}[c]{@{}l@{}}Optimized Plug\\ (ms)\end{tabular} \\ \hline
UDP Sender   & 4.6 & 300 & 0 \\ \hline
UDP Receiver & 1.8 & 300 & 0 \\ \hline
\end{tabular}
\caption{Network downtime experienced by iPerf UDP traffic during VM migration due to Unplug, Plug, and Optimized Plug operations of the HaaS VM's VFIO network device.}
\label{tab:downtime}
\end{table}

In this section, we show the network service disruption
due to transition from pass-through NIC to the virtual NIC 
on the source server and virtual NIC to the pass-through
NIC on the destination server.
We also demonstrate the average 
number of missed local timer interrupts in guest, 
when we disable the DTID.

\figw{seamless_migration_haas}{9}{Live VM migration with \na.}

The guest is configured with bonding driver in 
active-backup mode where the pass-through NIC acts as 
active slave and Virtio network device as 
backup slave. The bonding driver accepts 
\texttt{fail\_over\_mac} as parameter. The 
\texttt{fail\_over\_mac} parameter ensures that the
MAC address of the bond is always the same as the active
slave. Before migrtion, \na hot-unplugs the assigned
NIC. The bonding driver detects hot-unplug event as failure
of pass-through NIC and choses
Virtio NIC as the active slave. \texttt{fail\_over\_mac} 
switches the network 
traffic to the Virtio network interface by broadcasting
ARP packets notifying the change in MAC address of the bond.

In Figure~\ref{fig:seamless_migration_default}, we measure 
the bandwidth achieved by a HaaS VM during live migration
when running the iPerf benchmark over a 1Gbps network;
The VM sends the network traffic at 940Mbps bandwidth 
during regular execution. Just before migration, when the network traffic is 
switched by the bonding driver from the VFIO device to 
the Virtio network device using  hot-unplug of the VFIO device, 
the guest experiences 0.1 second network service disruption.
As shown in Figure~\ref{fig:seamless_migration_haas} with
\texttt{fail\_over\_mac} the downtime due to hot unplug reduces 
to 80ms.
During the migration of the guest, the guest continues
to run with the network bandwidth of 940Mbps using Virtio network
device. The guest experiences network dowtime of 
0.1seconds during the last phase of migration 
when the guest is paused on source server
to transfer the CPU and I/O state to destination server 
for guest resumption. After the guest resumes, the
destination server hot-plugs the network device. \na
sets the pass-through NIC as the active slave and
switches the network traffic from Virtio network interface
back to pass-through NIC. As shown in 
Figure~\ref{fig:seamless_migration_default}, the above step
introduces additional downtime of 0.3seconds.

In \na, to minimize the additional downtime introduced by
the hot-plug event, it is broken down to three steps.
As shown in Figure~\ref{fig:seamless_migration_haas}, 
the step a of creating software NIC object 
and step b of extracting the values from the 
configuration space are executed when the guest 
is paused. The last step c of resetting the 
software NIC object to setup the BAR and 
interrupt forwarding is executed after 
the guest migration is completed. In \na, as
shown in Figure~\ref{fig:seamless_migration_haas} the 
downtime due to hotplug passthrough NIC is zero
as the first two steps are executed when the guest is
paused. The total migration time remains unaffected.

In Table~\ref{tab:downtime}, when switching
from the VFIO (pass-through) network device to Virtio network device
at the source machine, the network downtime (in the ``Unplug'' column)
is observed to be 4.6ms for the UDP sender case and 1.8ms for the  UDP receiver case. 
When switching back from the Virtio to  VFIO network device at the destination
machine, the network downtime (in the ``Plug'' column)
is measured to be 300ms for both the UDP sender and receiver cases. 
After we mask the overhead of VFIO NIC
initialization at the destination machine,
the network downtime (in the ``Optimized Plug'' column) reduces to zero for both sender and receiver cases.

% TODO: Analysis of DTID algorithm in the guest shows the
% guest does not miss the next timer interrupt.
%When disabling the DTID, the timer interrupts received by the
%guest per seconds matches the expected frequency of timer
%interrupt received by the unmodified guest. Since KVM delivers
%the virtual interrupts with or without DTID, the guest can
%still receives its interrupt during the transition. The longer
%the transition takes, the later the migration starts. The host
%communicates with the guest by the TCP transmission. We expect
%most of the transition time is due to the packet transmission
%and processing. The average transition time is -- $\mu$s.
