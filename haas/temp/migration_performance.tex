% Migration performance.
% - Describe what we have done.
% - Include tables and figures.
% - Evaluate the performance and see if it match our goal.

%\figw{seamless_migration_default}{8}{Place holder for seamless
%migration. Top: Guest sends the outgoing traffic. Bottom:
%guest receives the incoming traffic.}
%\figw{seamless_migration_haas}{8}{Place holder for seamless
%migration. Top: Guest sends the outgoing traffic. Bottom:
%guest receives the incoming traffic.}

\figw{seamless_migration_default}{9}{Seamless migration
without \na}

\begin{table}[]
\begin{tabular}{|l|l|l|l|}
\hline
 & \begin{tabular}[c]{@{}l@{}}Unplug\\ (ms)\end{tabular} & \begin{tabular}[c]{@{}l@{}}Plug\\ (ms)\end{tabular} & \begin{tabular}[c]{@{}l@{}}OPTI. Plug\\ (ms)\end{tabular} \\ \hline
UDP Sender   & 4.6 & 300 & 0 \\ \hline
UDP Receiver & 1.8 & 300 & 0 \\ \hline
\end{tabular}
\caption{Network Downtime}
\end{table}

In this section, we show the network service disruption
due to transition from pass-through NIC to the virtual NIC 
on the source server and virtual NIC to the pass-through
NIC on the destination server.
We also demonstrate the average 
number of missed local timer interrupts in guest, 
when we disable the DTID.

\figw{seamless_migration_haas}{9}{Seamless
migration with \na}

The guest is configured with bonding driver in active-
backup mode where the pass-through NIC acts as 
active slave and Virtio network device as 
backup slave. The bonding driver accepts 
\texttt{fail\_over\_mac} as parameter. The 
\texttt{fail\_over\_mac} parameter ensures that the
MAC address of the bond is always the same as the active
slave. Before migrtion, \na hot-unplugs the assigned
NIC. The bonding driver detects hot-unplug event as failure
of pass-through NIC and choses
Virtio NIC as the active slave. \texttt{fail\_over\_mac} 
switches the network 
traffic to the Virtio network interface by broadcasting
ARP packets notifying the change in MAC address of the bond.
In Figure~\ref{fig:seamless_migration_default}, we measure 
the bandwidth of 1Gbps network card using iperf benchmark. 
The guest sends the network traffic at 940Mbps bandwidth 
during regular runtime. When the network traffic is 
switched by bonding driver from pass-through device to 
Virtio network device on hot-unplug of assigned device, 
the guest experiences 0.1second network service disruption.
As shown in Figure~\ref{fig:seamless_migration_haas} with
\texttt{fail\_over\_mac} the downtime due to hot unplug reduces 
to 80ms.
During the migration of the guest, the guest continues
to run with the network bandwidth of 940Mbps using Virtio network
device. The guest experiences network dowtime of 
0.1seconds during the last phase of migration 
when the guest is paused on source server
to transfer the CPU and I/O state to destination server 
for guest resumption. After the guest resumes, the
destination server hot-plugs the network device. \na
sets the pass-through NIC as the active slave and
switches the network traffic from Virtio network interface
back to pass-through NIC. As shown in 
Figure~\ref{fig:seamless_migration_default}, the above step
introduces additional downtime of 0.3seconds.

In \na, to minimize the additional downtime introduced by
the hot-plug event, it is broken down to three steps.
As shown in Figure~\ref{fig:seamless_migration_haas}, 
the step a of creating software NIC object 
and step b of extracting the values from the 
configuration space are executed when the guest 
is paused. The last step c of resetting the 
software NIC object to setup the BAR and 
interrupt forwarding is executed after 
the guest migration is completed. In \na, as
shown in Figure~\ref{fig:seamless_migration_haas} the 
downtime due to hotplug passthrough NIC is zero
as the first two steps are executed when the guest is
paused. The total migration time remains unaffected.

In Table~\ref{tab:migration_network_downtime}, when switching
from the assigned to Virtio network device, the network downtime
is 4.6 and 1.8ms for the UDP sender and receiver respectively. When
switching back from the Virtio to assigned network device, the
network is 300ms for both the UDP sender and receiver. 
After we hide the overhead of assigned NIC
creation during the VM migration, the network downtime is
reduced to zero for the UDP sender and receiver
respectively.

% TODO: Analysis of DTID algorithm in the guest shows the
% guest does not miss the next timer interrupt.
%When disabling the DTID, the timer interrupts received by the
%guest per seconds matches the expected frequency of timer
%interrupt received by the unmodified guest. Since KVM delivers
%the virtual interrupts with or without DTID, the guest can
%still receives its interrupt during the transition. The longer
%the transition takes, the later the migration starts. The host
%communicates with the guest by the TCP transmission. We expect
%most of the transition time is due to the packet transmission
%and processing. The average transition time is -- $\mu$s.
