% Migration performance.
% - Describe what we have done.
% - Include tables and figures.
% - Evaluate the performance and see if it match our goal.

\figw{seamless_migration}{10}{Place holder for seamless
migration. Top: Guest sends the outgoing traffic. Bottom:
guest receives the incoming traffic.}

\begin{table}[tbp]
\begin{tabular}{|l|l|l|l|}
\hline
& UNPLUG & PLUG & OPTI. PLUG \\ \hline
UDP SENDER & 4.6 & 300 & 0 \\ \hline
UDP RECEIVER & 1.8 & 300 & 0 \\ \hline
\end{tabular}
\caption{Network Downtime}
\label{tab:migration_network_downtime}
\end{table}

In this experiment, we show the network downtime when
switching between the assigned and Virtio network device. 
The guest is configured with bonding driver in active-
backup mode where the assigned device acts as 
active interface and Virtio network device as 
backup interface. We also demonstrate the average 
number of missed local timer interrupts in guest, 
when we disable the DTID.

In Figure~\ref{fig:default_seamless_migration}, we measure 
the bandwidth of 1Gbps network card using iperf. 
The guest sends the network traffic at 940Mbps bandwidth 
during regular runtime. When the network traffic is 
switched by bonding driver from assigned device to 
Virtio network device on hot unplug of assigned device, 
the guest experiences 0.3seconds network downtime. 
During the migration of the guest, the network
bandwidth remains to be 940Mbps using Virtio network
device. The guest experiences network dowtime of 
0.1seconds during the last phase of migration 
when the guest is paused on source host
to transfer the CPU and I/O state to destination host
for guest resumption. After the guest resumes on the
destination host, the guest is setup to use the assigned
device through hot plug event. After the assigned device
is hot plugged, the network traffic is switched from Virtio
network device to assigned device by setting the assigned
device as the active device.


In Table~\ref{tab:migration_network_downtime}, when switching
from the assigned to Virtio network device, the network is --
and -- ms for the UDP sender and receiver respectively. When
switching back from the Virtio to assigned network device, the
network is -- and -- ms for the UDP sender and receiver
respectively. After we hide the overhead of assigned NIC
creation during the VM migration, the network downtime is
reduced to -- and -- ms for the UDP sender and receiver
respectively.

When disabling the DTID, the timer interrupts received by the
guest per seconds matches the expected frequency of timer
interrupt received by the unmodified guest. Since KVM delivers
the virtual interrupts with or without DTID, the guest can
still receives its interrupt during the transition. The longer
the transition takes, the later the migration starts. The host
communicates with the guest by the TCP transmission. We expect
most of the transition time is due to the packet transmission
and processing. The average transition time is -- $\mu$s.

% TODO: Analysis of DTID algorithm in the guest shows the
% guest does not miss the next timer interrupt.
